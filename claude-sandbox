#!/bin/bash
# Initialize Claude Code DevContainer sandbox in the current directory
#
# Usage: claude-sandbox [options]
#   -f, --force    Overwrite existing .devcontainer
#   -o, --open     Open in VS Code after setup
#   -h, --help     Show this help message

set -e

TEMPLATE_DIR="$HOME/.config/devcontainer-templates/claude-sandbox"
TARGET_DIR=".devcontainer"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Parse arguments
FORCE=false
OPEN_VSCODE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    -f|--force)
      FORCE=true
      shift
      ;;
    -o|--open)
      OPEN_VSCODE=true
      shift
      ;;
    -h|--help)
      echo "Initialize Claude Code DevContainer sandbox in the current directory"
      echo ""
      echo "Usage: claude-sandbox [options]"
      echo ""
      echo "Options:"
      echo "  -f, --force    Overwrite existing .devcontainer"
      echo "  -o, --open     Open in VS Code after setup"
      echo "  -h, --help     Show this help message"
      echo ""
      echo "After setup, open in VS Code and use:"
      echo "  Cmd+Shift+P → 'Dev Containers: Reopen in Container'"
      exit 0
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      exit 1
      ;;
  esac
done

# Check if template exists
if [ ! -d "$TEMPLATE_DIR" ]; then
  echo -e "${RED}Error: Template not found at $TEMPLATE_DIR${NC}"
  echo "Please ensure the Claude sandbox template is installed."
  exit 1
fi

# Check if .devcontainer already exists
if [ -d "$TARGET_DIR" ] && [ "$FORCE" = false ]; then
  echo -e "${YELLOW}Warning: .devcontainer already exists in this directory.${NC}"
  echo "Use -f or --force to overwrite."
  exit 1
fi

# Copy template
echo -e "${GREEN}Setting up Claude Code sandbox...${NC}"

if [ -d "$TARGET_DIR" ]; then
  rm -rf "$TARGET_DIR"
fi

cp -r "$TEMPLATE_DIR" "$TARGET_DIR"

echo -e "${GREEN}✅ DevContainer created at .devcontainer/${NC}"
echo ""
echo "Files created:"
echo "  .devcontainer/devcontainer.json"
echo "  .devcontainer/Dockerfile"
echo "  .devcontainer/claude-settings.json"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  1. Open this folder in VS Code"
echo "  2. Cmd+Shift+P → 'Dev Containers: Reopen in Container'"
echo "  3. In container terminal: export AWS_ACCESS_KEY_ID=... && export AWS_SECRET_ACCESS_KEY=..."
echo "  4. Run: claude"

# Open in VS Code if requested
if [ "$OPEN_VSCODE" = true ]; then
  echo ""
  echo -e "${GREEN}Opening in VS Code...${NC}"
  code .
fi
