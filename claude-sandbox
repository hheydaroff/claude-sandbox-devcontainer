#!/bin/bash
# Initialize Claude Code DevContainer sandbox in the current directory
#
# Usage: claude-sandbox [options]
#   -f, --force        Overwrite existing .devcontainer
#   -o, --open         Open in VS Code after setup
#   -p, --provider     Auth provider: subscription, api-key, bedrock
#   -r, --region       AWS region (for Bedrock)
#   -m, --mount        Add extra mount path (can be used multiple times)
#   --no-docker        Disable Docker socket mount
#   --reconfigure      Re-run configuration prompts
#   -h, --help         Show this help message

set -e

# Directories
# Self-locating: find Dockerfile relative to this script (works with symlinks)
SCRIPT_PATH="$(readlink -f "$0" 2>/dev/null || realpath "$0" 2>/dev/null || echo "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
TEMPLATE_DIR="$SCRIPT_DIR/.devcontainer"
CONFIG_DIR="$HOME/.config/claude-sandbox"
CONFIG_FILE="$CONFIG_DIR/config"
TARGET_DIR=".devcontainer"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Default values
FORCE=false
OPEN_VSCODE=false
RECONFIGURE=false
EXTRA_MOUNTS=()

# Load saved config
load_config() {
  if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
  else
    CLAUDE_PROVIDER=""
    AWS_REGION="us-east-1"
    DOCKER_ENABLED="true"
  fi
}

# Prompt for choice
prompt_choice() {
  local question="$1"
  shift
  local options=("$@")

  echo -e "${BOLD}$question${NC}"
  echo ""

  local i=1
  for opt in "${options[@]}"; do
    echo -e "  ${CYAN}[$i]${NC} $opt"
    ((i++))
  done

  echo ""
  while true; do
    read -p "Choice [1-${#options[@]}]: " choice
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#options[@]}" ]; then
      REPLY=$choice
      return 0
    fi
    echo -e "${RED}Invalid choice. Please enter a number between 1 and ${#options[@]}.${NC}"
  done
}

# Run configuration prompts
run_configuration() {
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${BLUE}  Claude Sandbox Configuration${NC}"
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""

  # Auth method
  prompt_choice "How will you authenticate with Claude?" \
    "Claude Pro/Max subscription (claude login)" \
    "Anthropic API key (ANTHROPIC_API_KEY)" \
    "AWS Bedrock (AWS credentials)"

  case $REPLY in
    1) CLAUDE_PROVIDER="subscription" ;;
    2) CLAUDE_PROVIDER="api-key" ;;
    3) CLAUDE_PROVIDER="bedrock" ;;
  esac

  echo ""

  # Region (Bedrock only)
  if [ "$CLAUDE_PROVIDER" = "bedrock" ]; then
    prompt_choice "Select your AWS Bedrock region:" \
      "us-east-1 (N. Virginia)" \
      "us-west-2 (Oregon)" \
      "eu-central-1 (Frankfurt)" \
      "eu-west-1 (Ireland)" \
      "eu-west-3 (Paris)" \
      "ap-northeast-1 (Tokyo)" \
      "ap-southeast-1 (Singapore)" \
      "ap-southeast-2 (Sydney)"

    case $REPLY in
      1) AWS_REGION="us-east-1" ;;
      2) AWS_REGION="us-west-2" ;;
      3) AWS_REGION="eu-central-1" ;;
      4) AWS_REGION="eu-west-1" ;;
      5) AWS_REGION="eu-west-3" ;;
      6) AWS_REGION="ap-northeast-1" ;;
      7) AWS_REGION="ap-southeast-1" ;;
      8) AWS_REGION="ap-southeast-2" ;;
    esac

    echo ""
  fi

  # Docker detection
  if [ -S "/var/run/docker.sock" ]; then
    DOCKER_ENABLED="true"
  else
    DOCKER_ENABLED="false"
  fi

  # Save config
  mkdir -p "$CONFIG_DIR"
  cat > "$CONFIG_FILE" << EOF
# Claude Sandbox Configuration
CLAUDE_PROVIDER=$CLAUDE_PROVIDER
AWS_REGION=$AWS_REGION
DOCKER_ENABLED=$DOCKER_ENABLED
EOF

  echo -e "${GREEN}Configuration saved!${NC}"
  echo ""
}

# Extract MCP servers from ~/.claude.json (filtering incompatible ones)
# Creates claude.json (to be copied to ~/.claude.json in container)
extract_mcp_servers() {
  local CONFIG_TARGET="$1"
  [ -f "$HOME/.claude.json" ] || return 0

  python3 << EOF
import json
import os

claude_json_path = os.path.expanduser("~/.claude.json")
output_path = "$CONFIG_TARGET/claude.json"  # Will be copied to ~/.claude.json in container

# MCPs that won't work inside container (Docker socket MCP, etc.)
FILTERED_MCPS = {"MCP_DOCKER"}

with open(claude_json_path) as f:
    data = json.load(f)

# Filter MCP servers
mcp_servers = data.get("mcpServers", {})
filtered_mcps = {}

for name, config in mcp_servers.items():
    if name in FILTERED_MCPS:
        print(f"  Skipped MCP: {name} (not container-compatible)")
        continue
    filtered_mcps[name] = config
    print(f"  Included MCP: {name}")

# Preserve other fields from claude.json (preferences, etc.) and update mcpServers
output_data = data.copy()
output_data["mcpServers"] = filtered_mcps

with open(output_path, "w") as f:
    json.dump(output_data, f, indent=2)

if filtered_mcps:
    print(f"  Generated: claude.json ({len(filtered_mcps)} MCP servers)")
else:
    print(f"  Generated: claude.json (no container-compatible MCPs)")
EOF
}

# Sync Claude configuration to devcontainer
sync_claude_config() {
  local CONFIG_TARGET="$TARGET_DIR/claude-config"

  echo -e "${GREEN}Syncing Claude configuration...${NC}"
  mkdir -p "$CONFIG_TARGET/skills"

  # Copy CLAUDE.md (global instructions)
  if [ -f "$HOME/.claude/CLAUDE.md" ]; then
    cp "$HOME/.claude/CLAUDE.md" "$CONFIG_TARGET/"
    echo "  Copied: CLAUDE.md"
  fi

  # Copy settings.json (permissions, plugins, env)
  if [ -f "$HOME/.claude/settings.json" ]; then
    cp "$HOME/.claude/settings.json" "$CONFIG_TARGET/"
    echo "  Copied: settings.json"
  fi

  # Copy custom skills directory (preserve structure)
  if [ -d "$HOME/.claude/skills" ] && [ "$(ls -A $HOME/.claude/skills 2>/dev/null)" ]; then
    cp -R "$HOME/.claude/skills/"* "$CONFIG_TARGET/skills/" 2>/dev/null || true
    local skill_count=$(find "$CONFIG_TARGET/skills" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')
    echo "  Copied: skills/ ($skill_count custom skills)"
  fi

  # Extract and filter MCP servers (creates claude.json)
  extract_mcp_servers "$CONFIG_TARGET"

  # Create merge-settings.py for Bedrock (merges env settings while preserving host config)
  if [ "$CLAUDE_PROVIDER" = "bedrock" ]; then
    cat > "$CONFIG_TARGET/merge-settings.py" << 'MERGE_EOF'
#!/usr/bin/env python3
import json
import os

settings_path = os.path.expanduser("~/.claude/settings.json")
bedrock_path = "/workspace/.devcontainer/claude-settings.json"

# Load existing settings (from host sync) or empty
if os.path.exists(settings_path):
    with open(settings_path) as f:
        settings = json.load(f)
else:
    settings = {}

# Load Bedrock settings
if os.path.exists(bedrock_path):
    with open(bedrock_path) as f:
        bedrock = json.load(f)
    # Merge env (Bedrock env takes precedence)
    settings["env"] = {**settings.get("env", {}), **bedrock.get("env", {})}

# Write merged settings
os.makedirs(os.path.dirname(settings_path), exist_ok=True)
with open(settings_path, "w") as f:
    json.dump(settings, f, indent=2)

print("  Merged Bedrock settings into ~/.claude/settings.json")
MERGE_EOF
    echo "  Created: merge-settings.py"
  fi

  echo ""
}

# Generate devcontainer.json
generate_devcontainer() {
  local mounts_json=""
  local env_json=""
  local post_create_cmd=""

  # Always mount gitconfig (read-only)
  mounts_json='"source=${localEnv:HOME}/.gitconfig,target=/home/developer/.gitconfig,type=bind,readonly"'

  # Docker mount (if enabled)
  if [ "$DOCKER_ENABLED" = "true" ]; then
    mounts_json="$mounts_json,
    \"source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind\""
  fi

  # Extra mounts
  for mount_path in "${EXTRA_MOUNTS[@]}"; do
    local mount_name=$(basename "$mount_path")
    mounts_json="$mounts_json,
    \"source=$mount_path,target=/mnt/$mount_name,type=bind\""
  done

  # Add claude-config mount (synced host configuration)
  mounts_json="$mounts_json,
    \"source=\${localWorkspaceFolder}/.devcontainer/claude-config,target=/home/developer/.claude-sync,type=bind,readonly\""

  # Config sync command (runs first in postCreateCommand)
  # Copies: CLAUDE.md, settings.json, skills/* to ~/.claude/
  # Copies: claude.json to ~/.claude.json (MCP servers config)
  local config_sync_cmd="if [ -d ~/.claude-sync ]; then mkdir -p ~/.claude/skills && cp -f ~/.claude-sync/CLAUDE.md ~/.claude/ 2>/dev/null || true && cp -f ~/.claude-sync/settings.json ~/.claude/ 2>/dev/null || true && cp -R ~/.claude-sync/skills/* ~/.claude/skills/ 2>/dev/null || true && cp -f ~/.claude-sync/claude.json ~/.claude.json 2>/dev/null || true && echo 'Config synced from host'; fi && "

  # Environment variables and post-create command based on provider
  case "$CLAUDE_PROVIDER" in
    subscription)
      env_json=""
      post_create_cmd="${config_sync_cmd}mkdir -p ~/.claude && curl -fsSL https://claude.ai/install.sh | bash && export PATH=\\\"\$HOME/.local/bin:\$PATH\\\" && echo 'export PATH=\\\"\$HOME/.local/bin:\$PATH\\\"' >> ~/.bashrc && echo 'alias clauded=\\\"claude --dangerously-skip-permissions\\\"' >> ~/.bashrc && echo '' && echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━' && echo '  Claude Code Sandbox ready!' && echo '  Config synced: CLAUDE.md, settings, skills' && echo '  Run: claude login' && echo '  Then: clauded' && echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'"
      ;;
    api-key)
      env_json=""
      post_create_cmd="${config_sync_cmd}mkdir -p ~/.claude && curl -fsSL https://claude.ai/install.sh | bash && export PATH=\\\"\$HOME/.local/bin:\$PATH\\\" && echo 'export PATH=\\\"\$HOME/.local/bin:\$PATH\\\"' >> ~/.bashrc && echo 'alias clauded=\\\"claude --dangerously-skip-permissions\\\"' >> ~/.bashrc && echo '' && echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━' && echo '  Claude Code Sandbox ready!' && echo '  Config synced: CLAUDE.md, settings, skills' && echo '  Run: export ANTHROPIC_API_KEY=your-key' && echo '  Then: clauded' && echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'"
      ;;
    bedrock)
      env_json="\"AWS_DEFAULT_REGION\": \"$AWS_REGION\",
    \"AWS_REGION\": \"$AWS_REGION\""
      # For Bedrock: run merge script to combine env settings into synced settings (preserves permissions, plugins)
      local merge_settings_cmd="python3 ~/.claude-sync/merge-settings.py && "
      post_create_cmd="${config_sync_cmd}mkdir -p ~/.claude && ${merge_settings_cmd}curl -fsSL https://claude.ai/install.sh | bash && export PATH=\\\"\$HOME/.local/bin:\$PATH\\\" && echo 'export PATH=\\\"\$HOME/.local/bin:\$PATH\\\"' >> ~/.bashrc && echo 'alias clauded=\\\"claude --dangerously-skip-permissions\\\"' >> ~/.bashrc && echo '' && echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━' && echo '  Claude Code Sandbox ready!' && echo '  Config synced: CLAUDE.md, settings, skills' && echo '  Run: export AWS_ACCESS_KEY_ID=... && export AWS_SECRET_ACCESS_KEY=...' && echo '  Then: clauded' && echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'"
      ;;
  esac

  # Build containerEnv section
  local container_env=""
  if [ -n "$env_json" ]; then
    container_env="\"containerEnv\": {
    $env_json
  },"
  fi

  # Write devcontainer.json
  cat > "$TARGET_DIR/devcontainer.json" << EOF
{
  "name": "Claude Code Sandbox",
  "build": {
    "dockerfile": "Dockerfile"
  },
  "customizations": {
    "vscode": {
      "extensions": [
        "anthropic.claude-code"
      ],
      "settings": {
        "claudeCode.disableLoginPrompt": true,
        "claudeCode.allowDangerouslySkipPermissions": true
      }
    }
  },
  "mounts": [
    $mounts_json
  ],
  $container_env
  "remoteUser": "developer",
  "postCreateCommand": "$post_create_cmd"
}
EOF
}

# Generate claude-settings.json (Bedrock only)
generate_claude_settings() {
  if [ "$CLAUDE_PROVIDER" = "bedrock" ]; then
    # Determine model prefix based on region
    local model_prefix=""
    case "$AWS_REGION" in
      us-east-1|us-west-2) model_prefix="us" ;;
      eu-*) model_prefix="eu" ;;
      ap-*) model_prefix="ap" ;;
      *) model_prefix="us" ;;
    esac

    cat > "$TARGET_DIR/claude-settings.json" << EOF
{
  "env": {
    "CLAUDE_CODE_USE_BEDROCK": "1",
    "ANTHROPIC_MODEL": "${model_prefix}.anthropic.claude-opus-4-5-20251101-v1:0",
    "ANTHROPIC_DEFAULT_SONNET_MODEL": "${model_prefix}.anthropic.claude-sonnet-4-5-20250929-v1:0",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "${model_prefix}.anthropic.claude-haiku-4-5-20251001-v1:0",
    "AWS_REGION": "$AWS_REGION",
    "AWS_DEFAULT_REGION": "$AWS_REGION"
  }
}
EOF
  fi
}

# Show help
show_help() {
  echo "Initialize Claude Code DevContainer sandbox in the current directory"
  echo ""
  echo "Usage: claude-sandbox [options]"
  echo ""
  echo "Options:"
  echo "  -f, --force        Overwrite existing .devcontainer"
  echo "  -o, --open         Open in VS Code after setup"
  echo "  -p, --provider     Auth provider: subscription, api-key, bedrock"
  echo "  -r, --region       AWS region (for Bedrock): us-east-1, us-west-2, etc."
  echo "  -m, --mount        Add extra mount path (can be used multiple times)"
  echo "  --no-docker        Disable Docker socket mount"
  echo "  --reconfigure      Re-run configuration prompts"
  echo "  -h, --help         Show this help message"
  echo ""
  echo "Examples:"
  echo "  claude-sandbox                           # Use saved defaults"
  echo "  claude-sandbox --provider subscription   # Override to subscription"
  echo "  claude-sandbox --provider bedrock --region eu-central-1"
  echo "  claude-sandbox --mount /path/to/data     # Add extra mount"
  echo "  claude-sandbox --no-docker               # Disable Docker access"
  echo ""
  echo "Config file: $CONFIG_FILE"
}

# Parse arguments
parse_args() {
  while [[ $# -gt 0 ]]; do
    case $1 in
      -f|--force)
        FORCE=true
        shift
        ;;
      -o|--open)
        OPEN_VSCODE=true
        shift
        ;;
      -p|--provider)
        CLAUDE_PROVIDER="$2"
        shift 2
        ;;
      -r|--region)
        AWS_REGION="$2"
        shift 2
        ;;
      -m|--mount)
        EXTRA_MOUNTS+=("$2")
        shift 2
        ;;
      --no-docker)
        DOCKER_ENABLED="false"
        shift
        ;;
      --reconfigure)
        RECONFIGURE=true
        shift
        ;;
      -h|--help)
        show_help
        exit 0
        ;;
      *)
        echo -e "${RED}Unknown option: $1${NC}"
        echo "Use --help for usage information."
        exit 1
        ;;
    esac
  done
}

# Main
main() {
  # Load saved config first
  load_config

  # Parse command line arguments (override config)
  parse_args "$@"

  # Run configuration if needed
  if [ -z "$CLAUDE_PROVIDER" ] || [ "$RECONFIGURE" = true ]; then
    run_configuration
  fi

  # Check if Dockerfile template exists
  if [ ! -f "$TEMPLATE_DIR/Dockerfile" ]; then
    echo -e "${RED}Error: Dockerfile template not found at $TEMPLATE_DIR${NC}"
    echo "This usually means the installation is incomplete."
    echo "Please clone the repo and run install.sh:"
    echo "  git clone https://github.com/hheydaroff/claude-sandbox-devcontainer.git"
    echo "  cd claude-sandbox-devcontainer && ./install.sh"
    exit 1
  fi

  # Check if .devcontainer already exists
  if [ -d "$TARGET_DIR" ] && [ "$FORCE" = false ]; then
    echo -e "${YELLOW}Warning: .devcontainer already exists in this directory.${NC}"
    echo "Use -f or --force to overwrite."
    exit 1
  fi

  # Create .devcontainer directory
  echo -e "${GREEN}Setting up Claude Code sandbox...${NC}"
  mkdir -p "$TARGET_DIR"

  # Sync Claude configuration from host
  sync_claude_config

  # Copy Dockerfile
  cp "$TEMPLATE_DIR/Dockerfile" "$TARGET_DIR/Dockerfile"

  # Generate devcontainer.json
  generate_devcontainer

  # Generate claude-settings.json (if Bedrock)
  generate_claude_settings

  # Success message
  echo ""
  echo -e "${GREEN}DevContainer created at .devcontainer/${NC}"
  echo ""
  echo "Files created:"
  echo "  .devcontainer/devcontainer.json"
  echo "  .devcontainer/Dockerfile"
  echo "  .devcontainer/claude-config/ (synced from host)"
  if [ "$CLAUDE_PROVIDER" = "bedrock" ]; then
    echo "  .devcontainer/claude-settings.json"
  fi
  echo ""
  echo -e "Configuration:"
  echo -e "  Provider: ${CYAN}$CLAUDE_PROVIDER${NC}"
  if [ "$CLAUDE_PROVIDER" = "bedrock" ]; then
    echo -e "  Region:   ${CYAN}$AWS_REGION${NC}"
  fi
  echo -e "  Docker:   ${CYAN}$DOCKER_ENABLED${NC}"
  if [ ${#EXTRA_MOUNTS[@]} -gt 0 ]; then
    echo -e "  Mounts:   ${CYAN}${EXTRA_MOUNTS[*]}${NC}"
  fi
  echo ""
  echo -e "${YELLOW}Next steps:${NC}"
  echo "  1. Open this folder in VS Code"
  echo "  2. Cmd+Shift+P → 'Dev Containers: Reopen in Container'"
  case "$CLAUDE_PROVIDER" in
    subscription)
      echo "  3. In container: claude login"
      ;;
    api-key)
      echo "  3. In container: export ANTHROPIC_API_KEY=\"your-key\""
      ;;
    bedrock)
      echo "  3. In container: export AWS_ACCESS_KEY_ID=... && export AWS_SECRET_ACCESS_KEY=..."
      ;;
  esac
  echo "  4. Run: clauded"

  # Open in VS Code if requested
  if [ "$OPEN_VSCODE" = true ]; then
    echo ""
    echo -e "${GREEN}Opening in VS Code DevContainer...${NC}"

    # Try devcontainer CLI first (best experience)
    if command -v devcontainer &> /dev/null; then
      echo "  Using devcontainer CLI for direct container launch..."
      devcontainer open "$(pwd)"
    elif command -v code &> /dev/null; then
      # Fall back to VS Code with prompt
      code .
      echo ""
      echo -e "${YELLOW}Tip: Press Cmd+Shift+P and select 'Dev Containers: Reopen in Container'${NC}"
    else
      echo -e "${YELLOW}VS Code 'code' command not found in PATH${NC}"
      echo "Install it from VS Code: Cmd+Shift+P → 'Shell Command: Install code command'"
    fi
  fi
}

main "$@"
